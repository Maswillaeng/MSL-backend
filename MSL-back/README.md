1. 로그인 필터를 구현할까?


## JPA: N + 1 문제 발생
JPA를 사용하면 자주 만나게 되는 N + 1 문제!

간단하게 구조를 살펴보면,

## 처음 작성한 Service 로직
여기서 testAllPost 메서드를 호출하면 어떤 일이 발생할까?

### "N + 1 쿼리!"
게시글 하나를 조회하고, 게시글의 user, 게시글의 comment, like  
총 3개의 테이블이 연관관계가 맺어져있고,   
Lazy Loading으로 필요한 곳에서 사용되기 때문에  
`N + 1 쿼리 문제가 발생한다.`  
지금은 Post가 3개이기 대문에 첫 조회(1) + 1개의 user, 3개의 Comment, 3개의 like (7) = 8 밖에 발생하지 않았지만 ,
Post 조회 결과가 10만개, User 조회 결과 10만개, ...등등이 넘으면 어떻게 될까?  
`단순하게 등록되어있는 게시글을 조회하는 로직에서 DB 조회가 이렇게 많이 발생하는 건 말이 안 된다.`

## 해결 방법

### Fetch Join 적용하기

이렇게 1 : N 관계의 자식 테이블 여러곳에 Fetch Join을 사용하면 에러가 발생한다.  
JPA에서 Fetch Join의 조건은 다음과 같다.
- **ToOne은 몇개**든 사용 가능하다
- **ToMany는 1개만** 가능하다  

N + 1 문제를 피하는 방법은?  

### Hibernate default_batch_fetch_size 적용하기

N + 1 문제를 그림으로 확인해보자.

N + 1 문제는 결국 **부모 엔티티와 연관 관계가 있는 자식 엔티티들의 조회 쿼리**가 문제다.  

Post1의 값에서 Comment, PostLike 조회를 하고,  
Post2의 값에서 Comment, PostLike 조회를 하고 계속 .....  

부모에서 자식의 값을 계속 조회하기 때문에 발생하는 문제라고 생각하면 된다.  

**in절로 묶어서 조회하면 해결할 수 있다**  
`hibernate.default_batch_fetch_size` 옵션으로 해결할 수 있다!

size를 1000으로 설정하면, 1000개 단위로 조회한다는 뜻이다.  
쿼리 수행수가 1 / 1000이 된다는 뜻임!

`in (?, ?, .......)`인 것을 확인할 수 있다.  
6~7번 이상 반복되는 쿼리가 `3번으로 개선`  

**결과가 많으면 많을수록 엄청난 성능 개선이다**  

> Tip)
> 보통 옵션값을 1,000 이상 주지 않는다.  
> 1,000개 이상일 때 문제가 발생할 수 있음!  

## 설정 방법

`application.yml`
````java
spring:
  jpa:
    properties:
      hibernate.default_batch_fetch_size: 1000
````
`글로벌 설정`을 통해서 모든 프로젝트에 적용된다!


